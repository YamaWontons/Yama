        .admin-login {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .admin-login.hidden {
            display: none;
        }    <div class="admin-login hidden" id="adminLogin">
        <div class="container">
            <div class="header">
                <div class="logo">üîê Admin Access</div>
                <div class="subtitle">Yama Wontons Dashboard</div>
            </div>
            <div class="section">
                <h3>Login Required</h3>
                <input type="text" id="adminUsername" placeholder="Username" style="margin-bottom: 15px;">
                <input type="password" id="adminPassword" placeholder="Password" style="margin-bottom: 15px;">
                <button class="next-btn" onclick="checkAdminLogin()">Access Dashboard</button>
                <div id="loginError" style="color: #e74c3c; margin-top: 10px; display: none;">Invalid username or password</div>
            </div>
        </div>
    </div><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yama Wontons - Voice Feedback</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section.hidden {
            display: none;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .voice-section {
            text-align: center;
        }

        .prompt {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .voice-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .record-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .record-btn.recording {
            background: #ff4757;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .next-btn, .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .next-btn:hover, .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .status {
            text-align: center;
            margin: 15px 0;
            font-style: italic;
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .admin-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            color: white;
        }

        .admin-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .user-profile {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .recommendations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .rec-item {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9em;
        }

        .rec-try { background: #d4edda; color: #155724; }
        .rec-avoid { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <button onclick="showAdminLogin()" style="position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.1); border: none; padding: 8px; border-radius: 50%; cursor: pointer; color: white; font-size: 12px; opacity: 0.3;" title="Admin">üë§</button>
    <button onclick="downloadHTML()" style="position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.1); border: none; padding: 10px; border-radius: 50%; cursor: pointer; color: white;">üíæ</button>
    
    <div class="container" id="surveyContainer">
        <div class="header">
            <div class="logo">ü•ü Yama Wontons</div>
            <div class="subtitle">WhiskeyandWontons Feedback</div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- Step 1: Wonton Selection -->
        <div class="section" id="step1">
            <h3>Which wonton did you just taste?</h3>
            <select id="wontonSelect">
                <option value="">Select a wonton...</option>
                <option value="hangover-helper">Hangover Helper (Chicken Ginger)</option>
                <option value="energy-boost">Energy Boost (Ultimate Pork & Shrimp)</option>
                <option value="apres-adventure">Apr√®s-Adventure (Duck)</option>
                <option value="alpenglow-spicy">Alpenglow Spicy (Sichuan Beef)</option>
                <option value="wind-down-sleepy">Wind-Down Sleepy (Tofu & Mushroom)</option>
            </select>
            <input type="text" id="customerName" placeholder="Your name (optional)">
            <button class="next-btn" onclick="nextStep()">Continue</button>
        </div>

        <!-- Step 2: Voice Feedback -->
        <div class="section hidden" id="step2">
            <h3>Voice Feedback</h3>
            <div class="voice-section">
                <div class="prompt">
                    Tell me about the wonton you just tried - what did you think?
                </div>
                <div class="voice-controls">
                    <button class="record-btn" id="recordBtn" onclick="toggleRecording()">üé§</button>
                </div>
                <div class="status" id="recordingStatus">Tap the microphone to start recording</div>
                <button onclick="testMicrophone()" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin: 10px 0; cursor: pointer;">üîß Test Microphone Access</button>
                <textarea id="textInput" style="display:none; height:100px;" placeholder="Type your response here..."></textarea>
                <button class="next-btn" onclick="nextPrompt()" id="nextPromptBtn" style="display:none;">Continue</button>
            </div>
        </div>

        <!-- Step 3: Effects Tracking -->
        <div class="section hidden" id="step3">
            <h3>How are you feeling? (Optional)</h3>
            <p style="color: #666; margin-bottom: 15px;">This helps us understand if our wontons are having their intended effects.</p>
            <select id="effectSelect">
                <option value="">Select if you notice any effects...</option>
                <option value="clearer-head">Clearer head / less foggy</option>
                <option value="more-energy">More energized</option>
                <option value="better-recovery">Better recovery / less exhausted</option>
                <option value="warmer">Feeling warmer</option>
                <option value="more-relaxed">More relaxed / calmer</option>
                <option value="satisfied">Just satisfied and full</option>
                <option value="no-effect">No particular effect yet</option>
            </select>
            <button class="submit-btn" onclick="submitFeedback()">Submit Feedback</button>
        </div>

        <!-- Thank You -->
        <div class="section hidden" id="thankYou">
            <h3>Thank You! üôè</h3>
            <p>Your feedback helps us make better wontons!</p>
            <div class="user-profile" id="userProfile"></div>
            <button class="next-btn" onclick="resetSurvey()">Give More Feedback</button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="container hidden" id="adminPanel">
        <div class="admin-panel">
            <h2>Admin Dashboard</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalFeedback">0</div>
                    <div>Total Feedback</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgRating">0</div>
                    <div>Avg Sentiment</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="topWonton">-</div>
                    <div>Top Wonton</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Audio Recordings</h3>
                <div id="audioRecordings"></div>
            </div>

            <div class="chart-container">
                <h3>Wonton Performance</h3>
                <div id="wontonChart"></div>
            </div>

            <div class="chart-container">
                <h3>Recipe Insights & Recommendations</h3>
                <div id="recipeInsights"></div>
            </div>

            <button class="next-btn" onclick="logoutAdmin()">Logout & Back to Survey</button>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let currentFeedback = {};
        let allFeedback = JSON.parse(localStorage.getItem('wontonFeedback') || '[]');
        let userProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');

        function updateProgress() {
            const progress = (currentStep / 4) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function nextStep() {
            const wonton = document.getElementById('wontonSelect').value;
            const name = document.getElementById('customerName').value || 'Anonymous';
            
            if (!wonton) {
                alert('Please select a wonton first!');
                return;
            }
            
            currentFeedback = {
                wonton: wonton,
                customerName: name,
                timestamp: new Date().toISOString(),
                responses: [],
                sentiment: null,
                effect: null
            };
            
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            currentStep = 2;
            updateProgress();
            requestMicrophonePermission();
        }

        async function requestMicrophonePermission() {
            // Don't auto-request on page load, wait for user interaction
            document.getElementById('recordingStatus').innerHTML = `
                <div style="margin: 15px 0;">
                    <button onclick="requestMicAccess()" style="background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        üé§ Enable Voice Recording
                    </button>
                </div>
                <div style="font-size: 0.9em; color: #666;">Click above to allow microphone access, or use text input below</div>
            `;
            
            document.getElementById('recordBtn').style.display = 'none';
            document.getElementById('textInput').style.display = 'block';
            document.getElementById('nextPromptBtn').style.display = 'block';
        }

        async function requestMicAccess() {
            try {
                console.log('Requesting microphone permission...');
                console.log('Current URL:', window.location.href);
                console.log('Protocol:', window.location.protocol);
                
                // Check if getUserMedia is available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('getUserMedia not supported');
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });
                console.log('Microphone access granted!');
                
                // Stop the stream immediately
                stream.getTracks().forEach(track => track.stop());
                
                // Update UI to show success
                document.getElementById('recordingStatus').innerHTML = `
                    <div style="color: #2ecc71; font-weight: bold; margin-bottom: 10px;">‚úÖ Microphone enabled!</div>
                    <div style="font-size: 0.9em; color: #666;">Tap the microphone button below to start recording</div>
                `;
                
                document.getElementById('recordBtn').style.display = 'block';
                document.getElementById('textInput').style.display = 'none';
                document.getElementById('nextPromptBtn').style.display = 'none';
                
            } catch (error) {
                console.log('Full error details:', error);
                console.log('Error name:', error.name);
                console.log('Error message:', error.message);
                
                document.getElementById('recordingStatus').innerHTML = `
                    <div style="color: #e74c3c; font-weight: bold; margin-bottom: 10px;">‚ùå Microphone access failed</div>
                    <div style="font-size: 0.9em; color: #666; margin: 10px 0; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <strong>Debug Info:</strong><br>
                        Error: ${error.name}<br>
                        Message: ${error.message}<br>
                        URL: ${window.location.href}<br>
                        Protocol: ${window.location.protocol}<br>
                        Browser: ${navigator.userAgent.includes('Chrome') ? 'Chrome' : navigator.userAgent.includes('Safari') ? 'Safari' : 'Other'}
                    </div>
                    <div style="font-size: 0.9em; color: #667eea; margin-top: 15px;">
                        üí¨ No worries - text feedback works perfectly! Just type your response below.
                    </div>
                `;
                
                showMicrophoneError(error.name);
            }
        }

        function showMicrophoneError(errorType) {
            let message = '';
            let instructions = '';

            switch(errorType) {
                case 'NotAllowedError':
                    message = 'Microphone access denied';
                    instructions = 'Click the üîí icon in your address bar and allow microphone access, then refresh the page.';
                    break;
                case 'NotFoundError':
                    message = 'No microphone found';
                    instructions = 'Please connect a microphone or use the text input below.';
                    break;
                case 'NotSupportedError':
                    message = 'Voice recording not supported';
                    instructions = 'Your browser doesn\'t support voice recording. Please use the text input below.';
                    break;
                default:
                    message = 'Voice recording unavailable';
                    instructions = 'For voice recording to work, this page needs to be accessed via HTTPS. Please type your feedback below instead.';
            }

            document.getElementById('recordingStatus').innerHTML = `
                <div style="color: #e74c3c; font-weight: bold; margin-bottom: 10px;">${message}</div>
                <div style="font-size: 0.9em; color: #666; margin-bottom: 15px;">${instructions}</div>
                <div style="font-size: 0.9em; color: #667eea;">üí¨ No worries - text feedback works just as well!</div>
            `;
            
            document.getElementById('recordBtn').style.display = 'none';
            document.getElementById('textInput').style.display = 'block';
            document.getElementById('nextPromptBtn').style.display = 'block';
        }

        async function testMicrophone() {
            try {
                console.log('Testing microphone access...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('Microphone access granted!');
                
                document.getElementById('recordingStatus').innerHTML = `
                    <div style="color: #2ecc71; font-weight: bold;">‚úÖ Microphone test successful!</div>
                    <div style="font-size: 0.9em; color: #666;">You can now use voice recording. Tap the microphone button above.</div>
                `;
                
                // Stop the test stream
                stream.getTracks().forEach(track => track.stop());
                
                // Show the record button and hide text input
                document.getElementById('recordBtn').style.display = 'block';
                document.getElementById('textInput').style.display = 'none';
                document.getElementById('nextPromptBtn').style.display = 'none';
                
            } catch (error) {
                console.log('Microphone test failed:', error);
                document.getElementById('recordingStatus').innerHTML = `
                    <div style="color: #e74c3c; font-weight: bold;">‚ùå Microphone test failed</div>
                    <div style="font-size: 0.9em; color: #666; margin: 10px 0;">
                        Error: ${error.name} - ${error.message}
                    </div>
                    <div style="font-size: 0.9em; color: #667eea;">
                        ${window.location.protocol === 'https:' ? 
                            'Try allowing microphone permissions in your browser settings.' : 
                            'This page needs to be accessed via HTTPS for microphone access.'}
                    </div>
                `;
                showMicrophoneError(error.name);
            }
        }

        async function toggleRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        processAudioFeedback();
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    
                    document.getElementById('recordBtn').classList.add('recording');
                    document.getElementById('recordBtn').textContent = 'üõë';
                    document.getElementById('recordingStatus').textContent = 'Recording... tap to stop';
                } catch (error) {
                    console.log('Recording failed:', error.name);
                    showMicrophoneError(error.name);
                }
            } else {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    
                    document.getElementById('recordBtn').classList.remove('recording');
                    document.getElementById('recordBtn').textContent = 'üé§';
                    document.getElementById('recordingStatus').textContent = 'Processing...';
                }
            }
        }

        function processAudioFeedback() {
            // Show processing status
            document.getElementById('recordingStatus').innerHTML = `
                <div style="color: #3498db; font-weight: bold; margin-bottom: 10px;">üîÑ Converting speech to text...</div>
                <div style="font-size: 0.9em; color: #666;">Processing your recording...</div>
            `;
            
            // Create audio blob from recorded chunks
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            currentFeedback.audioBlob = audioBlob;
            currentFeedback.audioTimestamp = new Date().toISOString();
            
            // Try Web Speech API for real speech-to-text
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                startSpeechRecognition();
            } else {
                // Fallback: convert audio blob to URL and let user transcribe
                convertAudioAndShowEditor();
            }
        }

        function startSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    showTranscriptionResult(transcript, true);
                };
                
                recognition.onerror = function(event) {
                    console.log('Speech recognition error:', event.error);
                    convertAudioAndShowEditor();
                };
                
                recognition.onend = function() {
                    console.log('Speech recognition ended');
                };
                
                // Start recognition (Note: this won't work with pre-recorded audio)
                // We'll need to start fresh recognition
                setTimeout(() => {
                    convertAudioAndShowEditor();
                }, 2000);
                
            } catch (error) {
                console.log('Speech recognition failed:', error);
                convertAudioAndShowEditor();
            }
        }

        function convertAudioAndShowEditor() {
            // For now, show editor with placeholder
            // In production, you'd send the audio blob to a transcription service
            showTranscriptionResult("", false);
        }

        function showTranscriptionResult(transcribedText, wasAutoTranscribed) {
            const message = wasAutoTranscribed ? 
                "‚úÖ Audio transcribed! Please review and edit if needed:" :
                "‚ö†Ô∏è Please type what you said (automatic transcription not available):";
                
            document.getElementById('recordingStatus').innerHTML = `
                <div style="color: ${wasAutoTranscribed ? '#2ecc71' : '#f39c12'}; font-weight: bold; margin-bottom: 10px;">${message}</div>
                <div style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                    Your audio is saved. Please review/enter the text below:
                </div>
            `;
            
            // Show text area with transcribed text for editing
            document.getElementById('textInput').style.display = 'block';
            document.getElementById('textInput').value = transcribedText;
            document.getElementById('textInput').placeholder = "Type exactly what you said in your recording...";
            document.getElementById('textInput').focus();
            
            // Add buttons for re-record and continue
            const existingButtons = document.querySelector('.transcription-buttons');
            if (existingButtons) existingButtons.remove();
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'transcription-buttons';
            buttonContainer.style.cssText = 'display: flex; gap: 10px; margin: 15px 0;';
            buttonContainer.innerHTML = `
                <button onclick="reRecord()" style="flex: 1; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    üé§ Record Again
                </button>
                <button onclick="confirmTranscription()" style="flex: 1; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ‚úì Text is Correct
                </button>
            `;
            
            const textInput = document.getElementById('textInput');
            textInput.parentNode.insertBefore(buttonContainer, textInput.nextSibling);
            
            document.getElementById('nextPromptBtn').style.display = 'none';
        }

        function reRecord() {
            // Reset for new recording
            currentFeedback.audioBlob = null;
            audioChunks = [];
            
            // Remove button container
            const buttons = document.querySelector('.transcription-buttons');
            if (buttons) buttons.remove();
            
            // Reset UI
            document.getElementById('recordingStatus').textContent = 'Ready to record - tap the microphone';
            document.getElementById('textInput').style.display = 'none';
            document.getElementById('textInput').value = '';
            document.getElementById('nextPromptBtn').style.display = 'none';
        }

        function confirmTranscription() {
            const editedText = document.getElementById('textInput').value.trim();
            
            if (!editedText) {
                alert('Please enter your feedback text before continuing.');
                return;
            }
            
            const sentiment = analyzeSentiment(editedText);
            const insights = analyzeResponse(editedText, currentFeedback.wonton);
            
            currentFeedback.responses.push({
                response: editedText,
                sentiment: sentiment,
                insights: insights,
                hasAudioRecording: true,
                inputMethod: 'voice+edited',
                transcriptionMethod: 'user-verified'
            });

            document.getElementById('recordingStatus').innerHTML = `
                <div style="color: #2ecc71; font-weight: bold; margin-bottom: 10px;">‚úÖ Feedback recorded successfully!</div>
                <div style="background: #f8f9ff; padding: 10px; border-radius: 8px; margin: 10px 0;">
                    <strong>Your feedback:</strong> "${editedText}"
                </div>
            `;
            
            // Remove button container
            const buttons = document.querySelector('.transcription-buttons');
            if (buttons) buttons.remove();
            
            document.getElementById('textInput').style.display = 'none';
            document.getElementById('nextPromptBtn').style.display = 'block';
        }

        function simulateSpeechToText(wontonType) {
            // In production, replace this with actual speech-to-text API
            const responses = {
                'hangover-helper': [
                    "This really helped clear my head after last night. The ginger flavor is perfect and soothing.",
                    "I was feeling pretty rough this morning but this wonton soup made me feel so much better. The broth is amazing.",
                    "It's good but maybe a bit too gingery for my taste. I can see how it would help with hangovers though.",
                    "Exactly what I needed! The warming spices really helped settle my stomach and clear the fog in my brain."
                ],
                'energy-boost': [
                    "Wow, I actually feel more energized after eating this! The combination of pork and shrimp is incredible.",
                    "This is really filling and satisfying. Perfect after my workout, I feel completely refueled.",
                    "The flavors are amazing but I'm not sure I'm feeling the energy boost I expected. Still tasty though.",
                    "This is exactly what I needed for my afternoon slump. The broth is so rich and nourishing."
                ],
                'apres-adventure': [
                    "This duck is so rich and comforting, absolutely perfect after a long day of skiing!",
                    "The five-spice blend is incredible and I feel very restored after eating this. Such elegant flavors.",
                    "Really good flavor but it might be too rich for me to eat regularly. Great for special occasions.",
                    "This hits the spot after being outdoors all day. The duck broth is deeply satisfying and warming."
                ],
                'alpenglow-spicy': [
                    "The spice level is absolutely perfect! It's really warming me up on this cold evening.",
                    "I love the ma la sensation, exactly what I was craving. The numbing and spicy balance is spot on.",
                    "This is too spicy for me, I couldn't finish the whole bowl. But the beef quality is excellent.",
                    "Great for cold weather! The Sichuan peppers create such an interesting tingling sensation."
                ],
                'wind-down-sleepy': [
                    "This is so calming and peaceful, I can already feel myself relaxing. Perfect before bedtime.",
                    "The mushroom flavors are amazing and very zen-like. I love the subtle earthiness.",
                    "It's too subtle for my taste, I was hoping for more pronounced flavors. Nice concept though.",
                    "Actually feeling more relaxed already! The tofu is silky and the broth is very soothing."
                ]
            };
            
            const wontonResponses = responses[wontonType] || responses['energy-boost'];
            return wontonResponses[Math.floor(Math.random() * wontonResponses.length)];
        }

        function nextPrompt() {
            let response = '';
            const textInput = document.getElementById('textInput');
            
            // Handle text input if no voice recording was made
            if (textInput.style.display !== 'none' && textInput.value.trim() && !currentFeedback.audioBlob) {
                response = textInput.value.trim();
                const sentiment = analyzeSentiment(response);
                const insights = analyzeResponse(response, currentFeedback.wonton);
                
                currentFeedback.responses.push({
                    response: response,
                    sentiment: sentiment,
                    insights: insights,
                    hasAudioRecording: false,
                    inputMethod: 'text'
                });
            } else if (currentFeedback.responses.length === 0 && !currentFeedback.audioBlob) {
                alert('Please provide your feedback first!');
                return;
            }
            
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            currentStep = 3;
            updateProgress();
        }

        function getSimulatedResponse(wontonType) {
            const responses = {
                'hangover-helper': [
                    "It really helped clear my head, the ginger was perfect!",
                    "Felt so much better after eating this, very soothing.",
                    "Too gingery for me, but I can see how it would help others."
                ],
                'energy-boost': [
                    "Wow, I actually feel more energized! The broth is incredible.",
                    "Really filling and satisfying, perfect after my workout.",
                    "Good but didn't give me the energy boost I expected."
                ],
                'apres-adventure': [
                    "This duck is so rich and comforting, perfect after skiing!",
                    "The five-spice blend is incredible, feels very restorative.",
                    "Good flavor but maybe too rich for everyday eating."
                ],
                'alpenglow-spicy': [
                    "The spice level is perfect, really warming me up!",
                    "Love the ma la sensation, exactly what I was craving.",
                    "Too spicy for me, couldn't finish it."
                ],
                'wind-down-sleepy': [
                    "So calming and peaceful, perfect before bed.",
                    "The mushroom flavors are amazing, very zen-like.",
                    "Too subtle for my taste, needed more flavor."
                ]
            };
            
            const wontonResponses = responses[wontonType] || responses['energy-boost'];
            return wontonResponses[Math.floor(Math.random() * wontonResponses.length)];
        }

        function analyzeSentiment(text) {
            const positiveWords = ['delicious', 'perfect', 'amazing', 'incredible', 'helped', 'better', 'energized', 'comforting', 'relaxed', 'warming'];
            const negativeWords = ['too salty', 'too spicy', 'bland', 'underwhelming', 'disappointing', 'couldn\'t finish'];
            
            let score = 0;
            const lowerText = text.toLowerCase();
            
            positiveWords.forEach(word => {
                if (lowerText.includes(word)) score += 1;
            });
            
            negativeWords.forEach(word => {
                if (lowerText.includes(word)) score -= 1;
            });
            
            if (score > 0) return 'positive';
            if (score < 0) return 'negative';
            return 'neutral';
        }

        function analyzeResponse(text, wontonType) {
            const insights = {
                flavorFeedback: [],
                effectsFeedback: [],
                buyAgain: null
            };
            
            const lowerText = text.toLowerCase();
            
            // Check for flavor issues
            if (lowerText.includes('too salty')) insights.flavorFeedback.push('negative: too salty');
            if (lowerText.includes('too spicy')) insights.flavorFeedback.push('negative: too spicy');
            if (lowerText.includes('bland')) insights.flavorFeedback.push('negative: bland');
            if (lowerText.includes('perfect')) insights.flavorFeedback.push('positive: perfect');
            if (lowerText.includes('amazing')) insights.flavorFeedback.push('positive: amazing');
            
            // Check for effects
            const effectKeywords = {
                'hangover-helper': ['clear', 'head', 'better', 'soothing'],
                'energy-boost': ['energy', 'energized', 'boost'],
                'apres-adventure': ['comforting', 'restorative'],
                'alpenglow-spicy': ['warming', 'warm'],
                'wind-down-sleepy': ['relaxed', 'calm', 'peaceful']
            };
            
            if (effectKeywords[wontonType]) {
                effectKeywords[wontonType].forEach(word => {
                    if (lowerText.includes(word)) insights.effectsFeedback.push(word);
                });
            }
            
            // Check buy again intent
            if (lowerText.includes('again') || lowerText.includes('definitely')) {
                insights.buyAgain = true;
            } else if (lowerText.includes('never') || lowerText.includes('wouldn\'t')) {
                insights.buyAgain = false;
            }
            
            return insights;
        }

        function submitFeedback() {
            const effect = document.getElementById('effectSelect').value;
            currentFeedback.effect = effect;
            
            // Calculate overall sentiment from text responses
            if (currentFeedback.responses.length > 0) {
                currentFeedback.sentiment = currentFeedback.responses[0].sentiment;
            }
            
            // Store audio data separately for admin access
            if (currentFeedback.audioBlob) {
                // Convert audio blob to base64 for storage
                const reader = new FileReader();
                reader.onloadend = function() {
                    currentFeedback.audioData = reader.result;
                    saveAndContinue();
                };
                reader.readAsDataURL(currentFeedback.audioBlob);
            } else {
                saveAndContinue();
            }
        }

        function saveAndContinue() {
            allFeedback.push(currentFeedback);
            localStorage.setItem('wontonFeedback', JSON.stringify(allFeedback));
            
            updateUserProfile();
            
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('thankYou').classList.remove('hidden');
            currentStep = 4;
            updateProgress();
            
            displayUserProfile();
        }

        function updateUserProfile() {
            const name = currentFeedback.customerName;
            if (!userProfiles[name]) {
                userProfiles[name] = {
                    preferences: {},
                    totalFeedback: 0
                };
            }
            
            const profile = userProfiles[name];
            const wonton = currentFeedback.wonton;
            
            if (!profile.preferences[wonton]) {
                profile.preferences[wonton] = [];
            }
            
            profile.preferences[wonton].push({
                sentiment: currentFeedback.sentiment,
                timestamp: currentFeedback.timestamp
            });
            
            profile.totalFeedback++;
            localStorage.setItem('userProfiles', JSON.stringify(userProfiles));
        }

        function displayUserProfile() {
            const name = currentFeedback.customerName;
            const profile = userProfiles[name];
            
            if (!profile) return;
            
            document.getElementById('userProfile').innerHTML = `
                <h4>Your Taste Profile, ${name}!</h4>
                <p>Total feedback given: ${profile.totalFeedback}</p>
            `;
        }

        function resetSurvey() {
            currentStep = 1;
            currentFeedback = {};
            
            // Remove any leftover button containers
            const buttons = document.querySelector('.transcription-buttons');
            if (buttons) buttons.remove();
            
            document.getElementById('thankYou').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('wontonSelect').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('effectSelect').value = '';
            document.getElementById('textInput').value = '';
            document.getElementById('textInput').style.display = 'none';
            document.getElementById('recordBtn').style.display = 'block';
            document.getElementById('nextPromptBtn').style.display = 'none';
            
            updateProgress();
        }

        // Admin credentials (in production, use proper authentication)
        const ADMIN_CREDENTIALS = {
            username: 'yamawontons',
            password: 'whiskey2024'
        };

        let isAdminLoggedIn = false;

        function showAdminLogin() {
            document.getElementById('surveyContainer').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function checkAdminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('loginError').style.display = 'none';
                loadAdminData();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('adminPassword').value = '';
            }
        }

        function toggleAdmin() {
            if (!isAdminLoggedIn) {
                showAdminLogin();
                return;
            }
            
            const survey = document.getElementById('surveyContainer');
            const admin = document.getElementById('adminPanel');
            
            if (survey.classList.contains('hidden')) {
                survey.classList.remove('hidden');
                admin.classList.add('hidden');
            } else {
                survey.classList.add('hidden');
                admin.classList.remove('hidden');
                loadAdminData();
            }
        }

        function loadAdminData() {
            document.getElementById('totalFeedback').textContent = allFeedback.length;
            
            const sentimentScores = allFeedback.map(f => {
                if (f.sentiment === 'positive') return 1;
                if (f.sentiment === 'negative') return -1;
                return 0;
            });
            const avgSentiment = sentimentScores.length > 0 ? (sentimentScores.reduce((a, b) => a + b, 0) / sentimentScores.length).toFixed(1) : 0;
            document.getElementById('avgRating').textContent = avgSentiment;
            
            const wontonCounts = {};
            allFeedback.forEach(f => {
                wontonCounts[f.wonton] = (wontonCounts[f.wonton] || 0) + 1;
            });
            
            if (Object.keys(wontonCounts).length > 0) {
                const topWonton = Object.keys(wontonCounts).reduce((a, b) => wontonCounts[a] > wontonCounts[b] ? a : b);
                document.getElementById('topWonton').textContent = getWontonDisplayName(topWonton);
            }
            
            loadWontonChart();
            loadRecipeInsights();
            loadAudioRecordings();
        }

        function getWontonDisplayName(wontonKey) {
            const names = {
                'hangover-helper': 'Hangover Helper',
                'energy-boost': 'Energy Boost',
                'apres-adventure': 'Apr√®s-Adventure',
                'alpenglow-spicy': 'Alpenglow Spicy',
                'wind-down-sleepy': 'Wind-Down Sleepy'
            };
            return names[wontonKey] || wontonKey;
        }

        function loadWontonChart() {
            const wontonStats = {};
            allFeedback.forEach(f => {
                if (!wontonStats[f.wonton]) {
                    wontonStats[f.wonton] = { positive: 0, negative: 0, neutral: 0, total: 0 };
                }
                wontonStats[f.wonton][f.sentiment]++;
                wontonStats[f.wonton].total++;
            });
            
            let chartHTML = '';
            Object.entries(wontonStats).forEach(([wonton, stats]) => {
                const positivePercent = (stats.positive / stats.total * 100).toFixed(1);
                chartHTML += `
                    <div style="margin-bottom: 15px; padding: 15px; background: #f8f9ff; border-radius: 10px;">
                        <strong>${getWontonDisplayName(wonton)}</strong> (${stats.total} responses)
                        <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-top: 5px;">
                            <div style="background: #2ecc71; height: 20px; width: ${positivePercent}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                ${positivePercent}% positive
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('wontonChart').innerHTML = chartHTML || '<p>No data available yet.</p>';
        }

        function loadRecipeInsights() {
            const insights = {};
            
            allFeedback.forEach(f => {
                if (!insights[f.wonton]) {
                    insights[f.wonton] = {
                        name: getWontonDisplayName(f.wonton),
                        flavorIssues: [],
                        buyAgainCount: 0,
                        totalResponses: 0
                    };
                }
                
                const insight = insights[f.wonton];
                insight.totalResponses++;
                
                if (f.responses && f.responses.length > 0) {
                    f.responses.forEach(response => {
                        if (response.insights) {
                            if (response.insights.flavorFeedback) {
                                response.insights.flavorFeedback.forEach(feedback => {
                                    if (feedback.includes('negative:')) {
                                        insight.flavorIssues.push(feedback.replace('negative: ', ''));
                                    }
                                });
                            }
                            
                            if (response.insights.buyAgain) {
                                insight.buyAgainCount++;
                            }
                        }
                    });
                }
            });
            
            let insightsHTML = '';
            Object.values(insights).forEach(insight => {
                const buyAgainPercent = insight.totalResponses > 0 ? ((insight.buyAgainCount / insight.totalResponses) * 100).toFixed(1) : 0;
                
                insightsHTML += `
                    <div style="margin-bottom: 20px; padding: 20px; background: #f8f9ff; border-radius: 10px;">
                        <h4>${insight.name}</h4>
                        <p><strong>Would Buy Again:</strong> ${buyAgainPercent}%</p>
                        ${insight.flavorIssues.length > 0 ? `
                            <div style="margin: 10px 0;">
                                <strong style="color: #e74c3c;">Common Issues:</strong>
                                ${[...new Set(insight.flavorIssues)].join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            document.getElementById('recipeInsights').innerHTML = insightsHTML || '<p>No insights available yet.</p>';
        }

        function logoutAdmin() {
            isAdminLoggedIn = false;
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('surveyContainer').classList.remove('hidden');
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        function loadAudioRecordings() {
            const audioFeedback = allFeedback.filter(f => f.audioData || f.audioBlob);
            
            if (audioFeedback.length === 0) {
                document.getElementById('audioRecordings').innerHTML = '<p>No audio recordings yet.</p>';
                return;
            }
            
            let audioHTML = '';
            audioFeedback.forEach((feedback, index) => {
                const date = new Date(feedback.timestamp).toLocaleString();
                const textSummary = feedback.responses && feedback.responses[0] ? feedback.responses[0].response : 'No text summary provided';
                const sentiment = feedback.sentiment || 'unknown';
                
                audioHTML += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9ff; border-radius: 10px; border-left: 4px solid ${sentiment === 'positive' ? '#2ecc71' : sentiment === 'negative' ? '#e74c3c' : '#f39c12'};">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong>${feedback.customerName || 'Anonymous'}</strong> - ${getWontonDisplayName(feedback.wonton)}
                                <br><small style="color: #666;">${date}</small>
                            </div>
                            <span style="background: ${sentiment === 'positive' ? '#d4edda' : sentiment === 'negative' ? '#f8d7da' : '#fff3cd'}; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px;">
                                ${sentiment}
                            </span>
                        </div>
                        
                        ${feedback.audioData ? `
                            <audio controls style="width: 100%; margin: 10px 0;">
                                <source src="${feedback.audioData}" type="audio/wav">
                                Your browser does not support audio playback.
                            </audio>
                        ` : '<div style="color: #666; font-style: italic;">Audio data not available</div>'}
                        
                        <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 5px;">
                            <strong>Transcribed Text:</strong><br>
                            <em>"${textSummary}"</em>
                            ${feedback.responses && feedback.responses[0] && feedback.responses[0].transcriptionMethod ? 
                                `<br><small style="color: #666;">Method: ${feedback.responses[0].transcriptionMethod}</small>` : ''}
                        </div>
                        
                        ${feedback.effect ? `<div style="margin-top: 5px; color: #666;"><strong>Effects:</strong> ${feedback.effect}</div>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('audioRecordings').innerHTML = audioHTML;
        }

        // Initialize
        updateProgress();

        function downloadHTML() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'yama-wonton-survey.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>