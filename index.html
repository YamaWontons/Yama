<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yama Wontons - Voice Feedback</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section.hidden {
            display: none;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .voice-section {
            text-align: center;
        }

        .prompt {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .voice-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .record-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .record-btn.recording {
            background: #ff4757;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .next-btn, .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .next-btn:hover, .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .status {
            text-align: center;
            margin: 15px 0;
            font-style: italic;
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .admin-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            color: white;
        }

        .admin-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .user-profile {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .recommendations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .rec-item {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9em;
        }

        .rec-try { background: #d4edda; color: #155724; }
        .rec-avoid { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <button class="admin-toggle" onclick="toggleAdmin()">‚öôÔ∏è</button>
    <button onclick="downloadHTML()" style="position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.1); border: none; padding: 10px; border-radius: 50%; cursor: pointer; color: white;">üíæ</button>
    
    <div class="container" id="surveyContainer">
        <div class="header">
            <div class="logo">ü•ü Yama Wontons</div>
            <div class="subtitle">WhiskeyandWontons Feedback</div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- Step 1: Wonton Selection -->
        <div class="section" id="step1">
            <h3>Which wonton did you just taste?</h3>
            <select id="wontonSelect">
                <option value="">Select a wonton...</option>
                <option value="hangover-helper">Hangover Helper (Chicken Ginger)</option>
                <option value="energy-boost">Energy Boost (Ultimate Pork & Shrimp)</option>
                <option value="apres-adventure">Apr√®s-Adventure (Duck)</option>
                <option value="alpenglow-spicy">Alpenglow Spicy (Sichuan Beef)</option>
                <option value="wind-down-sleepy">Wind-Down Sleepy (Tofu & Mushroom)</option>
            </select>
            <input type="text" id="customerName" placeholder="Your name (optional)">
            <button class="next-btn" onclick="nextStep()">Continue</button>
        </div>

        <!-- Step 2: Voice Feedback -->
        <div class="section hidden" id="step2">
            <h3>Voice Feedback</h3>
            <div class="voice-section">
                <div class="prompt">
                    Tell me about the wonton you just tried - what did you think?
                </div>
                <div class="voice-controls">
                    <button class="record-btn" id="recordBtn" onclick="toggleRecording()">üé§</button>
                </div>
                <div class="status" id="recordingStatus">Tap the microphone to start recording</div>
                <button onclick="testMicrophone()" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin: 10px 0; cursor: pointer;">üîß Test Microphone Access</button>
                <textarea id="textInput" style="display:none; height:100px;" placeholder="Type your response here..."></textarea>
                <button class="next-btn" onclick="nextPrompt()" id="nextPromptBtn" style="display:none;">Continue</button>
            </div>
        </div>

        <!-- Step 3: Effects Tracking -->
        <div class="section hidden" id="step3">
            <h3>How are you feeling? (Optional)</h3>
            <p style="color: #666; margin-bottom: 15px;">This helps us understand if our wontons are having their intended effects.</p>
            <select id="effectSelect">
                <option value="">Select if you notice any effects...</option>
                <option value="clearer-head">Clearer head / less foggy</option>
                <option value="more-energy">More energized</option>
                <option value="better-recovery">Better recovery / less exhausted</option>
                <option value="warmer">Feeling warmer</option>
                <option value="more-relaxed">More relaxed / calmer</option>
                <option value="satisfied">Just satisfied and full</option>
                <option value="no-effect">No particular effect yet</option>
            </select>
            <button class="submit-btn" onclick="submitFeedback()">Submit Feedback</button>
        </div>

        <!-- Thank You -->
        <div class="section hidden" id="thankYou">
            <h3>Thank You! üôè</h3>
            <p>Your feedback helps us make better wontons!</p>
            <div class="user-profile" id="userProfile"></div>
            <button class="next-btn" onclick="resetSurvey()">Give More Feedback</button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="container hidden" id="adminPanel">
        <div class="admin-panel">
            <h2>Admin Dashboard</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalFeedback">0</div>
                    <div>Total Feedback</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgRating">0</div>
                    <div>Avg Sentiment</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="topWonton">-</div>
                    <div>Top Wonton</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Wonton Performance</h3>
                <div id="wontonChart"></div>
            </div>

            <div class="chart-container">
                <h3>Recipe Insights & Recommendations</h3>
                <div id="recipeInsights"></div>
            </div>

            <button class="next-btn" onclick="toggleAdmin()">Back to Survey</button>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let currentFeedback = {};
        let allFeedback = JSON.parse(localStorage.getItem('wontonFeedback') || '[]');
        let userProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');

        function updateProgress() {
            const progress = (currentStep / 4) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function nextStep() {
            const wonton = document.getElementById('wontonSelect').value;
            const name = document.getElementById('customerName').value || 'Anonymous';
            
            if (!wonton) {
                alert('Please select a wonton first!');
                return;
            }
            
            currentFeedback = {
                wonton: wonton,
                customerName: name,
                timestamp: new Date().toISOString(),
                responses: [],
                sentiment: null,
                effect: null
            };
            
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            currentStep = 2;
            updateProgress();
            requestMicrophonePermission();
        }

        async function requestMicrophonePermission() {
            // Don't auto-request on page load, wait for user interaction
            document.getElementById('recordingStatus').innerHTML = `
                <div style="margin: 15px 0;">
                    <button onclick="requestMicAccess()" style="background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        üé§ Enable Voice Recording
                    </button>
                </div>
                <div style="font-size: 0.9em; color: #666;">Click above to allow microphone access, or use text input below</div>
            `;
            
            document.getElementById('recordBtn').style.display = 'none';
            document.getElementById('textInput').style.display = 'block';
            document.getElementById('nextPromptBtn').style.display = 'block';
        }

        async function requestMicAccess() {
            try {
                console.log('Requesting microphone permission...');
                console.log('Current URL:', window.location.href);
                console.log('Protocol:', window.location.protocol);
                
                // Check if getUserMedia is available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('getUserMedia not supported');
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });
                console.log('Microphone access granted!');
                
                // Stop the stream immediately
                stream.getTracks().forEach(track => track.stop());
                
                // Update UI to show success
                document.getElementById('recordingStatus').innerHTML = `
                    <div style="color: #2ecc71; font-weight: bold; margin-bottom: 10px;">‚úÖ Microphone enabled!</div>
                    <div style="font-size: 0.9em; color: #666;">Tap the microphone button below to start recording</div>
                `;
                
                document.getElementById('recordBtn').style.display = 'block';
                document.getElementById('textInput').style.display = 'none';
                document.getElementById('nextPromptBtn').style.display = 'none';
                
            } catch (error) {
                console.log('Full error details:', error);
                console.log('Error name:', error.name);
                console.log('Error message:', error.message);
                
                document.getElementById('recordingStatus').innerHTML = `
                    <div style="color: #e74c3c; font-weight: bold; margin-bottom: 10px;">‚ùå Microphone access failed</div>
                    <div style="font-size: 0.9em; color: #666; margin: 10px 0; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <strong>Debug Info:</strong><br>
                        Error: ${error.name}<br>
                        Message: ${error.message}<br>
                        URL: ${window.location.href}<br>
                        Protocol: ${window.location.protocol}<br>
                        Browser: ${navigator.userAgent.includes('Chrome') ? 'Chrome' : navigator.userAgent.includes('Safari') ? 'Safari' : 'Other'}
                    </div>
                    <div style="font-size: 0.9em; color: #667eea; margin-top: 15px;">
                        üí¨ No worries - text feedback works perfectly! Just type your response below.
                    </div>
                `;
                
                showMicrophoneError(error.name);
            }
        }

        function showMicrophoneError(errorType) {
            let message = '';
            let instructions = '';

            switch(errorType) {
                case 'NotAllowedError':
                    message = 'Microphone access denied';
                    instructions = 'Click the üîí icon in your address bar and allow microphone access, then refresh the page.';
                    break;
                case 'NotFoundError':
                    message = 'No microphone found';
                    instructions = 'Please connect a microphone or use the text input below.';
                    break;
                case 'NotSupportedError':
                    message = 'Voice recording not supported';
                    instructions = 'Your browser doesn\'t support voice recording. Please use the text input below.';
                    break;
                default:
                    message = 'Voice recording unavailable';
                    instructions = 'For voice recording to work, this page needs to be accessed via HTTPS. Please type your feedback below instead.';
            }

            document.getElementById('recordingStatus').innerHTML = `
                <div style="color: #e74c3c; font-weight: bold; margin-bottom: 10px;">${message}</div>
                <div style="font-size: 0.9em; color: #666; margin-bottom: 15px;">${instructions}</div>
                <div style="font-size: 0.9em; color: #667eea;">üí¨ No worries - text feedback works just as well!</div>
            `;
            
            document.getElementById('recordBtn').style.display = 'none';
            document.getElementById('textInput').style.display = 'block';
            document.getElementById('nextPromptBtn').style.display = 'block';
        }

        async function testMicrophone() {
            try {
                console.log('Testing microphone access...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('Microphone access granted!');
                
                document.getElementById('recordingStatus').innerHTML = `
                    <div style="color: #2ecc71; font-weight: bold;">‚úÖ Microphone test successful!</div>
                    <div style="font-size: 0.9em; color: #666;">You can now use voice recording. Tap the microphone button above.</div>
                `;
                
                // Stop the test stream
                stream.getTracks().forEach(track => track.stop());
                
                // Show the record button and hide text input
                document.getElementById('recordBtn').style.display = 'block';
                document.getElementById('textInput').style.display = 'none';
                document.getElementById('nextPromptBtn').style.display = 'none';
                
            } catch (error) {
                console.log('Microphone test failed:', error);
                document.getElementById('recordingStatus').innerHTML = `
                    <div style="color: #e74c3c; font-weight: bold;">‚ùå Microphone test failed</div>
                    <div style="font-size: 0.9em; color: #666; margin: 10px 0;">
                        Error: ${error.name} - ${error.message}
                    </div>
                    <div style="font-size: 0.9em; color: #667eea;">
                        ${window.location.protocol === 'https:' ? 
                            'Try allowing microphone permissions in your browser settings.' : 
                            'This page needs to be accessed via HTTPS for microphone access.'}
                    </div>
                `;
                showMicrophoneError(error.name);
            }
        }

        async function toggleRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        processAudioFeedback();
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    
                    document.getElementById('recordBtn').classList.add('recording');
                    document.getElementById('recordBtn').textContent = 'üõë';
                    document.getElementById('recordingStatus').textContent = 'Recording... tap to stop';
                } catch (error) {
                    console.log('Recording failed:', error.name);
                    showMicrophoneError(error.name);
                }
            } else {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    
                    document.getElementById('recordBtn').classList.remove('recording');
                    document.getElementById('recordBtn').textContent = 'üé§';
                    document.getElementById('recordingStatus').textContent = 'Processing...';
                }
            }
        }

        function processAudioFeedback() {
            setTimeout(() => {
                const simulatedResponse = getSimulatedResponse(currentFeedback.wonton);
                const sentiment = analyzeSentiment(simulatedResponse);
                const insights = analyzeResponse(simulatedResponse, currentFeedback.wonton);
                
                currentFeedback.responses.push({
                    response: simulatedResponse,
                    sentiment: sentiment,
                    insights: insights
                });

                document.getElementById('recordingStatus').textContent = `Recorded: "${simulatedResponse}"`;
                document.getElementById('nextPromptBtn').style.display = 'block';
            }, 2000);
        }

        function nextPrompt() {
            let response = '';
            const textInput = document.getElementById('textInput');
            
            if (textInput.style.display !== 'none' && textInput.value.trim()) {
                response = textInput.value.trim();
                const sentiment = analyzeSentiment(response);
                const insights = analyzeResponse(response, currentFeedback.wonton);
                
                currentFeedback.responses.push({
                    response: response,
                    sentiment: sentiment,
                    insights: insights
                });
            } else if (currentFeedback.responses.length === 0) {
                alert('Please provide your feedback first!');
                return;
            }
            
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            currentStep = 3;
            updateProgress();
        }

        function getSimulatedResponse(wontonType) {
            const responses = {
                'hangover-helper': [
                    "It really helped clear my head, the ginger was perfect!",
                    "Felt so much better after eating this, very soothing.",
                    "Too gingery for me, but I can see how it would help others."
                ],
                'energy-boost': [
                    "Wow, I actually feel more energized! The broth is incredible.",
                    "Really filling and satisfying, perfect after my workout.",
                    "Good but didn't give me the energy boost I expected."
                ],
                'apres-adventure': [
                    "This duck is so rich and comforting, perfect after skiing!",
                    "The five-spice blend is incredible, feels very restorative.",
                    "Good flavor but maybe too rich for everyday eating."
                ],
                'alpenglow-spicy': [
                    "The spice level is perfect, really warming me up!",
                    "Love the ma la sensation, exactly what I was craving.",
                    "Too spicy for me, couldn't finish it."
                ],
                'wind-down-sleepy': [
                    "So calming and peaceful, perfect before bed.",
                    "The mushroom flavors are amazing, very zen-like.",
                    "Too subtle for my taste, needed more flavor."
                ]
            };
            
            const wontonResponses = responses[wontonType] || responses['energy-boost'];
            return wontonResponses[Math.floor(Math.random() * wontonResponses.length)];
        }

        function analyzeSentiment(text) {
            const positiveWords = ['delicious', 'perfect', 'amazing', 'incredible', 'helped', 'better', 'energized', 'comforting', 'relaxed', 'warming'];
            const negativeWords = ['too salty', 'too spicy', 'bland', 'underwhelming', 'disappointing', 'couldn\'t finish'];
            
            let score = 0;
            const lowerText = text.toLowerCase();
            
            positiveWords.forEach(word => {
                if (lowerText.includes(word)) score += 1;
            });
            
            negativeWords.forEach(word => {
                if (lowerText.includes(word)) score -= 1;
            });
            
            if (score > 0) return 'positive';
            if (score < 0) return 'negative';
            return 'neutral';
        }

        function analyzeResponse(text, wontonType) {
            const insights = {
                flavorFeedback: [],
                effectsFeedback: [],
                buyAgain: null
            };
            
            const lowerText = text.toLowerCase();
            
            // Check for flavor issues
            if (lowerText.includes('too salty')) insights.flavorFeedback.push('negative: too salty');
            if (lowerText.includes('too spicy')) insights.flavorFeedback.push('negative: too spicy');
            if (lowerText.includes('bland')) insights.flavorFeedback.push('negative: bland');
            if (lowerText.includes('perfect')) insights.flavorFeedback.push('positive: perfect');
            if (lowerText.includes('amazing')) insights.flavorFeedback.push('positive: amazing');
            
            // Check for effects
            const effectKeywords = {
                'hangover-helper': ['clear', 'head', 'better', 'soothing'],
                'energy-boost': ['energy', 'energized', 'boost'],
                'apres-adventure': ['comforting', 'restorative'],
                'alpenglow-spicy': ['warming', 'warm'],
                'wind-down-sleepy': ['relaxed', 'calm', 'peaceful']
            };
            
            if (effectKeywords[wontonType]) {
                effectKeywords[wontonType].forEach(word => {
                    if (lowerText.includes(word)) insights.effectsFeedback.push(word);
                });
            }
            
            // Check buy again intent
            if (lowerText.includes('again') || lowerText.includes('definitely')) {
                insights.buyAgain = true;
            } else if (lowerText.includes('never') || lowerText.includes('wouldn\'t')) {
                insights.buyAgain = false;
            }
            
            return insights;
        }

        function submitFeedback() {
            const effect = document.getElementById('effectSelect').value;
            currentFeedback.effect = effect;
            
            // Calculate overall sentiment
            if (currentFeedback.responses.length > 0) {
                currentFeedback.sentiment = currentFeedback.responses[0].sentiment;
            }
            
            allFeedback.push(currentFeedback);
            localStorage.setItem('wontonFeedback', JSON.stringify(allFeedback));
            
            updateUserProfile();
            
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('thankYou').classList.remove('hidden');
            currentStep = 4;
            updateProgress();
            
            displayUserProfile();
        }

        function updateUserProfile() {
            const name = currentFeedback.customerName;
            if (!userProfiles[name]) {
                userProfiles[name] = {
                    preferences: {},
                    totalFeedback: 0
                };
            }
            
            const profile = userProfiles[name];
            const wonton = currentFeedback.wonton;
            
            if (!profile.preferences[wonton]) {
                profile.preferences[wonton] = [];
            }
            
            profile.preferences[wonton].push({
                sentiment: currentFeedback.sentiment,
                timestamp: currentFeedback.timestamp
            });
            
            profile.totalFeedback++;
            localStorage.setItem('userProfiles', JSON.stringify(userProfiles));
        }

        function displayUserProfile() {
            const name = currentFeedback.customerName;
            const profile = userProfiles[name];
            
            if (!profile) return;
            
            document.getElementById('userProfile').innerHTML = `
                <h4>Your Taste Profile, ${name}!</h4>
                <p>Total feedback given: ${profile.totalFeedback}</p>
            `;
        }

        function resetSurvey() {
            currentStep = 1;
            currentFeedback = {};
            
            document.getElementById('thankYou').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('wontonSelect').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('effectSelect').value = '';
            document.getElementById('textInput').value = '';
            document.getElementById('textInput').style.display = 'none';
            document.getElementById('recordBtn').style.display = 'block';
            document.getElementById('nextPromptBtn').style.display = 'none';
            
            updateProgress();
        }

        function toggleAdmin() {
            const survey = document.getElementById('surveyContainer');
            const admin = document.getElementById('adminPanel');
            
            if (survey.classList.contains('hidden')) {
                survey.classList.remove('hidden');
                admin.classList.add('hidden');
            } else {
                survey.classList.add('hidden');
                admin.classList.remove('hidden');
                loadAdminData();
            }
        }

        function loadAdminData() {
            document.getElementById('totalFeedback').textContent = allFeedback.length;
            
            const sentimentScores = allFeedback.map(f => {
                if (f.sentiment === 'positive') return 1;
                if (f.sentiment === 'negative') return -1;
                return 0;
            });
            const avgSentiment = sentimentScores.length > 0 ? (sentimentScores.reduce((a, b) => a + b, 0) / sentimentScores.length).toFixed(1) : 0;
            document.getElementById('avgRating').textContent = avgSentiment;
            
            const wontonCounts = {};
            allFeedback.forEach(f => {
                wontonCounts[f.wonton] = (wontonCounts[f.wonton] || 0) + 1;
            });
            
            if (Object.keys(wontonCounts).length > 0) {
                const topWonton = Object.keys(wontonCounts).reduce((a, b) => wontonCounts[a] > wontonCounts[b] ? a : b);
                document.getElementById('topWonton').textContent = getWontonDisplayName(topWonton);
            }
            
            loadWontonChart();
            loadRecipeInsights();
        }

        function getWontonDisplayName(wontonKey) {
            const names = {
                'hangover-helper': 'Hangover Helper',
                'energy-boost': 'Energy Boost',
                'apres-adventure': 'Apr√®s-Adventure',
                'alpenglow-spicy': 'Alpenglow Spicy',
                'wind-down-sleepy': 'Wind-Down Sleepy'
            };
            return names[wontonKey] || wontonKey;
        }

        function loadWontonChart() {
            const wontonStats = {};
            allFeedback.forEach(f => {
                if (!wontonStats[f.wonton]) {
                    wontonStats[f.wonton] = { positive: 0, negative: 0, neutral: 0, total: 0 };
                }
                wontonStats[f.wonton][f.sentiment]++;
                wontonStats[f.wonton].total++;
            });
            
            let chartHTML = '';
            Object.entries(wontonStats).forEach(([wonton, stats]) => {
                const positivePercent = (stats.positive / stats.total * 100).toFixed(1);
                chartHTML += `
                    <div style="margin-bottom: 15px; padding: 15px; background: #f8f9ff; border-radius: 10px;">
                        <strong>${getWontonDisplayName(wonton)}</strong> (${stats.total} responses)
                        <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-top: 5px;">
                            <div style="background: #2ecc71; height: 20px; width: ${positivePercent}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                ${positivePercent}% positive
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('wontonChart').innerHTML = chartHTML || '<p>No data available yet.</p>';
        }

        function loadRecipeInsights() {
            const insights = {};
            
            allFeedback.forEach(f => {
                if (!insights[f.wonton]) {
                    insights[f.wonton] = {
                        name: getWontonDisplayName(f.wonton),
                        flavorIssues: [],
                        buyAgainCount: 0,
                        totalResponses: 0
                    };
                }
                
                const insight = insights[f.wonton];
                insight.totalResponses++;
                
                if (f.responses && f.responses.length > 0) {
                    f.responses.forEach(response => {
                        if (response.insights) {
                            if (response.insights.flavorFeedback) {
                                response.insights.flavorFeedback.forEach(feedback => {
                                    if (feedback.includes('negative:')) {
                                        insight.flavorIssues.push(feedback.replace('negative: ', ''));
                                    }
                                });
                            }
                            
                            if (response.insights.buyAgain) {
                                insight.buyAgainCount++;
                            }
                        }
                    });
                }
            });
            
            let insightsHTML = '';
            Object.values(insights).forEach(insight => {
                const buyAgainPercent = insight.totalResponses > 0 ? ((insight.buyAgainCount / insight.totalResponses) * 100).toFixed(1) : 0;
                
                insightsHTML += `
                    <div style="margin-bottom: 20px; padding: 20px; background: #f8f9ff; border-radius: 10px;">
                        <h4>${insight.name}</h4>
                        <p><strong>Would Buy Again:</strong> ${buyAgainPercent}%</p>
                        ${insight.flavorIssues.length > 0 ? `
                            <div style="margin: 10px 0;">
                                <strong style="color: #e74c3c;">Common Issues:</strong>
                                ${[...new Set(insight.flavorIssues)].join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            document.getElementById('recipeInsights').innerHTML = insightsHTML || '<p>No insights available yet.</p>';
        }

        // Initialize
        updateProgress();

        function downloadHTML() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'yama-wonton-survey.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>