<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yama Wontons - Voice Feedback</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section.hidden {
            display: none;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .voice-section {
            text-align: center;
        }

        .prompt {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .voice-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .record-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .record-btn.recording {
            background: #ff4757;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .next-btn, .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .next-btn:hover, .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .status {
            text-align: center;
            margin: 15px 0;
            font-style: italic;
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .admin-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .user-profile {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .recommendations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .rec-item {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9em;
        }

        .rec-try { background: #d4edda; color: #155724; }
        .rec-avoid { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <button onclick="showAdminLogin()" style="position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.1); border: none; padding: 8px; border-radius: 50%; cursor: pointer; color: white; font-size: 12px; opacity: 0.3;" title="Admin">👤</button>
    <button onclick="downloadHTML()" style="position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.1); border: none; padding: 10px; border-radius: 50%; cursor: pointer; color: white;">💾</button>
    
    <div class="container" id="surveyContainer">
        <div class="header">
            <div class="logo">🥟 Yama Wontons</div>
            <div class="subtitle">WhiskeyandWontons Feedback</div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- Step 1: Wonton Selection -->
        <div class="section" id="step1">
            <h3>Which wonton did you just taste?</h3>
            <select id="wontonSelect">
                <option value="">Select a wonton...</option>
                <option value="hangover-helper">Hangover Helper (Chicken Ginger)</option>
                <option value="energy-boost">Energy Boost (Ultimate Pork & Shrimp)</option>
                <option value="apres-adventure">Après-Adventure (Duck)</option>
                <option value="alpenglow-spicy">Alpenglow Spicy (Sichuan Beef)</option>
                <option value="wind-down-sleepy">Wind-Down Sleepy (Tofu & Mushroom)</option>
            </select>
            <input type="text" id="customerName" placeholder="Your name (optional)">
            <button class="next-btn" onclick="nextStep()">Continue</button>
        </div>

        <!-- Step 2: Voice Feedback -->
        <div class="section hidden" id="step2">
            <h3>Voice Feedback</h3>
            <div class="voice-section">
                <div class="prompt">
                    Tell me about the wonton you just tried - what did you think?
                </div>
                <div class="voice-controls">
                    <button class="record-btn" id="recordBtn" onclick="toggleRecording()">🎤</button>
                </div>
                <div class="status" id="recordingStatus">Tap the microphone to start recording</div>
                <button onclick="requestMicAccess()" style="background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; display: none;" id="enableMicBtn">
                    🎤 Enable Voice Recording
                </button>
                <textarea id="textInput" style="display:none; height:100px;" placeholder="Type your response here..."></textarea>
                <button class="next-btn" onclick="nextPrompt()" id="nextPromptBtn" style="display:none;">Continue</button>
            </div>
        </div>

        <!-- Step 3: Effects Tracking -->
        <div class="section hidden" id="step3">
            <h3>How are you feeling? (Optional)</h3>
            <p style="color: #666; margin-bottom: 15px;">This helps us understand if our wontons are having their intended effects.</p>
            <select id="effectSelect">
                <option value="">Select if you notice any effects...</option>
                <option value="clearer-head">Clearer head / less foggy</option>
                <option value="more-energy">More energized</option>
                <option value="better-recovery">Better recovery / less exhausted</option>
                <option value="warmer">Feeling warmer</option>
                <option value="more-relaxed">More relaxed / calmer</option>
                <option value="satisfied">Just satisfied and full</option>
                <option value="no-effect">No particular effect yet</option>
            </select>
            <button class="submit-btn" onclick="submitFeedback()">Submit Feedback</button>
        </div>

        <!-- Thank You -->
        <div class="section hidden" id="thankYou">
            <h3>Thank You! 🙏</h3>
            <p>Your feedback helps us make better wontons!</p>
            <div class="user-profile" id="userProfile"></div>
            <button class="next-btn" onclick="resetSurvey()">Give More Feedback</button>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="adminLogin" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000;">
        <div class="container">
            <div class="header">
                <div class="logo">🔐 Admin Access</div>
                <div class="subtitle">Yama Wontons Dashboard</div>
            </div>
            <div class="section">
                <h3>Login Required</h3>
                <input type="text" id="adminUsername" placeholder="Username" style="margin-bottom: 15px;">
                <input type="password" id="adminPassword" placeholder="Password" style="margin-bottom: 15px;">
                <button class="next-btn" onclick="checkAdminLogin()">Access Dashboard</button>
                <div id="loginError" style="color: #e74c3c; margin-top: 10px; display: none;">Invalid username or password</div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="container" id="adminPanel" style="display: none;">
        <div class="admin-panel">
            <h2>Admin Dashboard</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalFeedback">0</div>
                    <div>Total Feedback</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgRating">0</div>
                    <div>Avg Sentiment</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="topWonton">-</div>
                    <div>Top Wonton</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Audio Recordings</h3>
                <div id="audioRecordings"></div>
            </div>

            <div class="chart-container">
                <h3>Wonton Performance</h3>
                <div id="wontonChart"></div>
            </div>

            <div class="chart-container">
                <h3>Recipe Insights & Recommendations</h3>
                <div id="recipeInsights"></div>
            </div>

            <button class="next-btn" onclick="logoutAdmin()">Logout & Back to Survey</button>
        </div>
    </div>

    <script>
        // AssemblyAI Configuration
        const ASSEMBLYAI_API_KEY = 'e9b5d8457ac7451da46140ec4f74713b';
        
        let currentStep = 1;
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let currentFeedback = {};
        let allFeedback = JSON.parse(localStorage.getItem('wontonFeedback') || '[]');
        let userProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');

        // Admin credentials
        const ADMIN_CREDENTIALS = {
            username: 'yamawontons',
            password: 'whiskey2024'
        };

        let isAdminLoggedIn = false;

        function updateProgress() {
            const progress = (currentStep / 4) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function nextStep() {
            const wonton = document.getElementById('wontonSelect').value;
            const name = document.getElementById('customerName').value || 'Anonymous';
            
            if (!wonton) {
                alert('Please select a wonton first!');
                return;
            }
            
            currentFeedback = {
                wonton: wonton,
                customerName: name,
                timestamp: new Date().toISOString(),
                responses: [],
                sentiment: null,
                effect: null
            };
            
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            currentStep = 2;
            updateProgress();
            requestMicrophonePermission();
        }

        async function requestMicrophonePermission() {
            document.getElementById('recordingStatus').innerHTML = `
                <div style="margin: 15px 0;">
                    <button onclick="requestMicAccess()" style="background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        🎤 Enable Voice Recording
                    </button>
                </div>
                <div style="font-size: 0.9em; color: #666;">Click above to allow microphone access, or use text input below</div>
            `;
            
            document.getElementById('recordBtn').style.display = 'none';
            document.getElementById('textInput').style.display = 'block';
            document.getElementById('nextPromptBtn').style.display = 'block';
        }

        async function requestMicAccess() {
            try {
                console.log('Requesting microphone permission...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });
                console.log('Microphone access granted!');
                
                stream.getTracks().forEach(track => track.stop());
                
                document.getElementById('recordingStatus').innerHTML = `
                    <div style="color: #2ecc71; font-weight: bold; margin-bottom: 10px;">✅ Microphone enabled!</div>
                    <div style="font-size: 0.9em; color: #666;">Tap the microphone button below to start recording</div>
                `;
                
                document.getElementById('recordBtn').style.display = 'block';
                document.getElementById('textInput').style.display = 'none';
                document.getElementById('nextPromptBtn').style.display = 'none';
                
            } catch (error) {
                console.log('Permission denied:', error);
                document.getElementById('recordingStatus').innerHTML = `
                    <div style="color: #e74c3c; font-weight: bold; margin-bottom: 10px;">❌ Microphone access denied</div>
                    <div style="font-size: 0.9em; color: #666; margin: 10px 0;">
                        Please allow microphone access in your browser settings, or use text input below.
                    </div>
                `;
            }
        }

        async function toggleRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        processAudioFeedback();
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    
                    document.getElementById('recordBtn').classList.add('recording');
                    document.getElementById('recordBtn').textContent = '🛑';
                    document.getElementById('recordingStatus').textContent = 'Recording... tap to stop';
                } catch (error) {
                    console.log('Recording failed:', error);
                    document.getElementById('recordingStatus').textContent = 'Recording failed - please use text input below';
                    document.getElementById('recordBtn').style.display = 'none';
                    document.getElementById('textInput').style.display = 'block';
                    document.getElementById('nextPromptBtn').style.display = 'block';
                }
            } else {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    
                    document.getElementById('recordBtn').classList.remove('recording');
                    document.getElementById('recordBtn').textContent = '🎤';
                    document.getElementById('recordingStatus').textContent = 'Processing...';
                }
            }
        }

        function processAudioFeedback() {
            document.getElementById('recordingStatus').innerHTML = `
                <div style="color: #3498db; font-weight: bold; margin-bottom: 10px;">🔄 Converting speech to text...</div>
                <div style="font-size: 0.9em; color: #666;">Processing your recording with AI...</div>
            `;
            
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            currentFeedback.audioBlob = audioBlob;
            currentFeedback.audioTimestamp = new Date().toISOString();
            
            if (ASSEMBLYAI_API_KEY && ASSEMBLYAI_API_KEY !== 'YOUR_API_KEY_HERE') {
                transcribeWithAssemblyAI(audioBlob);
            } else {
                showTranscriptionResult("", false, 0, "API key not configured");
            }
        }

        async function transcribeWithAssemblyAI(audioBlob) {
            try {
                const uploadResponse = await fetch('https://api.assemblyai.com/v2/upload', {
                    method: 'POST',
                    headers: {
                        'authorization': ASSEMBLYAI_API_KEY,
                    },
                    body: audioBlob
                });
                
                const uploadData = await uploadResponse.json();
                const audioUrl = uploadData.upload_url;
                
                const transcriptResponse = await fetch('https://api.assemblyai.com/v2/transcript', {
                    method: 'POST',
                    headers: {
                        'authorization': ASSEMBLYAI_API_KEY,
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        audio_url: audioUrl,
                        language_code: 'en'
                    })
                });
                
                const transcriptData = await transcriptResponse.json();
                const transcriptId = transcriptData.id;
                
                pollForTranscription(transcriptId);
                
            } catch (error) {
                console.error('AssemblyAI error:', error);
                showTranscriptionResult("", false, 0, "Transcription service unavailable");
            }
        }

        async function pollForTranscription(transcriptId) {
            const maxAttempts = 30;
            let attempts = 0;
            
            const poll = async () => {
                attempts++;
                
                try {
                    const response = await fetch(`https://api.assemblyai.com/v2/transcript/${transcriptId}`, {
                        headers: {
                            'authorization': ASSEMBLYAI_API_KEY,
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        showTranscriptionResult(data.text, true, data.confidence || 0.8);
                    } else if (data.status === 'error') {
                        showTranscriptionResult("", false, 0, "Transcription failed");
                    } else if (attempts < maxAttempts) {
                        setTimeout(poll, 1000);
                    } else {
                        showTranscriptionResult("", false, 0, "Transcription timeout");
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    showTranscriptionResult("", false, 0, "Connection error");
                }
            };
            
            poll();
        }

        function showTranscriptionResult(transcribedText, wasAutoTranscribed, confidence, errorMessage) {
            let message, color;
            
            if (wasAutoTranscribed) {
                message = `✅ Transcribed! (${Math.round(confidence * 100)}% confidence)`;
                color = '#2ecc71';
            } else if (errorMessage) {
                message = `⚠️ ${errorMessage}`;
                color = '#e74c3c';
            } else {
                message = "🎤 Audio recorded! Please type what you said:";
                color = '#3498db';
            }
                
            document.getElementById('recordingStatus').innerHTML = `
                <div style="color: ${color}; font-weight: bold; margin-bottom: 10px;">${message}</div>
                <div style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                    Your audio is saved. ${wasAutoTranscribed ? 'Please review and edit if needed:' : 'Please type exactly what you said:'}
                </div>
                ${errorMessage ? `<div style="font-size: 0.8em; color: #666; font-style: italic;">Note: You can add your AssemblyAI API key to enable automatic transcription.</div>` : ''}
            `;
            
            document.getElementById('textInput').style.display = 'block';
            document.getElementById('textInput').value = transcribedText;
            document.getElementById('textInput').placeholder = "Type exactly what you said in your recording...";
            document.getElementById('textInput').focus();
            
            const existingButtons = document.querySelector('.transcription-buttons');
            if (existingButtons) existingButtons.remove();
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'transcription-buttons';
            buttonContainer.style.cssText = 'display: flex; gap: 10px; margin: 15px 0;';
            buttonContainer.innerHTML = `
                <button onclick="reRecord()" style="flex: 1; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    🎤 Record Again
                </button>
                <button onclick="confirmTranscription()" style="flex: 1; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ✓ Continue
                </button>
            `;
            
            const textInput = document.getElementById('textInput');
            textInput.parentNode.insertBefore(buttonContainer, textInput.nextSibling);
            
            document.getElementById('nextPromptBtn').style.display = 'none';
        }

        function reRecord() {
            currentFeedback.audioBlob = null;
            audioChunks = [];
            
            const buttons = document.querySelector('.transcription-buttons');
            if (buttons) buttons.remove();
            
            document.getElementById('recordingStatus').textContent = 'Ready to record - tap the microphone';
            document.getElementById('textInput').style.display = 'none';
            document.getElementById('textInput').value = '';
            document.getElementById('nextPromptBtn').style.display = 'none';
        }

        function confirmTranscription() {
            const editedText = document.getElementById('textInput').value.trim();
            
            if (!editedText) {
                alert('Please enter your feedback text before continuing.');
                return;
            }
            
            const sentiment = analyzeSentiment(editedText);
            const insights = analyzeResponse(editedText, currentFeedback.wonton);
            
            currentFeedback.responses.push({
                response: editedText,
                sentiment: sentiment,
                insights: insights,
                hasAudioRecording: true,
                inputMethod: 'voice+edited',
                transcriptionMethod: 'user-verified'
            });

            document.getElementById('recordingStatus').innerHTML = `
                <div style="color: #2ecc71; font-weight: bold; margin-bottom: 10px;">✅ Feedback recorded successfully!</div>
                <div style="background: #f8f9ff; padding: 10px; border-radius: 8px; margin: 10px 0;">
                    <strong>Your feedback:</strong> "${editedText}"
                </div>
            `;
            
            const buttons = document.querySelector('.transcription-buttons');
            if (buttons) buttons.remove();
            
            document.getElementById('textInput').style.display = 'none';
            document.getElementById('nextPromptBtn').style.display = 'block';
        }

        function nextPrompt() {
            let response = '';
            const textInput = document.getElementById('textInput');
            
            if (textInput.style.display !== 'none' && textInput.value.trim() && !currentFeedback.audioBlob) {
                response = textInput.value.trim();
                const sentiment = analyzeSentiment(response);
                const insights = analyzeResponse(response, currentFeedback.wonton);
                
                currentFeedback.responses.push({
                    response: response,
                    sentiment: sentiment,
                    insights: insights,
                    hasAudioRecording: false,
                    inputMethod: 'text'
                });
            } else if (currentFeedback.responses.length === 0 && !currentFeedback.audioBlob) {
                alert('Please provide your feedback first!');
                return;
            }
            
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            currentStep = 3;
            updateProgress();
        }

        function analyzeSentiment(text) {
            const positiveWords = ['delicious', 'loved', 'perfect', 'amazing', 'favorite', 'great', 'best', 'incredible', 'fantastic', 'helped', 'better', 'energized', 'comforting', 'relaxed', 'warming'];
            const negativeWords = ['too salty', 'too spicy', 'bland', 'okay', 'nothing special', 'underwhelming', 'disappointing', 'soggy', 'sluggish', 'couldn\'t finish'];
            
            let score = 0;
            const lowerText = text.toLowerCase();
            
            positiveWords.forEach(word => {
                if (lowerText.includes(word)) score += 1;
            });
            
            negativeWords.forEach(word => {
                if (lowerText.includes(word)) score -= 1;
            });
            
            if (score > 0) return 'positive';
            if (score < 0) return 'negative';
            return 'neutral';
        }

        function analyzeResponse(text, wontonType) {
            const insights = {
                flavorFeedback: [],
                effectsFeedback: [],
                buyAgain: null
            };
            
            const lowerText = text.toLowerCase();
            
            if (lowerText.includes('too salty')) insights.flavorFeedback.push('negative: too salty');
            if (lowerText.includes('too spicy')) insights.flavorFeedback.push('negative: too spicy');
            if (lowerText.includes('bland')) insights.flavorFeedback.push('negative: bland');
            if (lowerText.includes('perfect')) insights.flavorFeedback.push('positive: perfect');
            if (lowerText.includes('amazing')) insights.flavorFeedback.push('positive: amazing');
            
            const effectKeywords = {
                'hangover-helper': ['clear', 'head', 'better', 'soothing'],
                'energy-boost': ['energy', 'energized', 'boost'],
                'apres-adventure': ['comforting', 'restorative'],
                'alpenglow-spicy': ['warming', 'warm'],
                'wind-down-sleepy': ['relaxed', 'calm', 'peaceful']
            };
            
            if (effectKeywords[wontonType]) {
                effectKeywords[wontonType].forEach(word => {
                    if (lowerText.includes(word)) insights.effectsFeedback.push(word);
                });
            }
            
            if (lowerText.includes('again') || lowerText.includes('definitely')) {
                insights.buyAgain = true;
            } else if (lowerText.includes('never') || lowerText.includes('wouldn\'t')) {
                insights.buyAgain = false;
            }
            
            return insights;
        }

        function submitFeedback() {
            const effect = document.getElementById('effectSelect').value;
            currentFeedback.effect = effect;
            
            if (currentFeedback.responses.length > 0) {
                currentFeedback.sentiment = currentFeedback.responses[0].sentiment;
            }
            
            if (currentFeedback.audioBlob) {
                const reader = new FileReader();
                reader.onloadend = function() {
                    currentFeedback.audioData = reader.result;
                    saveAndContinue();
                };
                reader.readAsDataURL(currentFeedback.audioBlob);
            } else {
                saveAndContinue();
            }
        }

        function saveAndContinue() {
            allFeedback.push(currentFeedback);
            localStorage.setItem('wontonFeedback', JSON.stringify(allFeedback));
            
            updateUserProfile();
            
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('thankYou').classList.remove('hidden');
            currentStep = 4;
            updateProgress();
            
            displayUserProfile();
        }

        function updateUserProfile() {
            const name = currentFeedback.customerName;
            if (!userProfiles[name]) {
                userProfiles[name] = {
                    preferences: {},
                    totalFeedback: 0
                };
            }
            
            const profile = userProfiles[name];
            const wonton = currentFeedback.wonton;
            
            if (!profile.preferences[wonton]) {
                profile.preferences[wonton] = [];
            }
            
            profile.preferences[wonton].push({
                sentiment: currentFeedback.sentiment,
                timestamp: currentFeedback.timestamp
            });
            
            profile.totalFeedback++;
            localStorage.setItem('userProfiles', JSON.stringify(userProfiles));
        }

        function displayUserProfile() {
            const name = currentFeedback.customerName;
            const profile = userProfiles[name];
            
            if (!profile) return;
            
            document.getElementById('userProfile').innerHTML = `
                <h4>Your Taste Profile, ${name}!</h4>
                <p>Total feedback given: ${profile.totalFeedback}</p>
            `;
        }

        function resetSurvey() {
            currentStep = 1;
            currentFeedback = {};
            
            const buttons = document.querySelector('.transcription-buttons');
            if (buttons) buttons.remove();
            
            document.getElementById('thankYou').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('wontonSelect').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('effectSelect').value = '';
            document.getElementById('textInput').value = '';
            document.getElementById('textInput').style.display = 'none';
            document.getElementById('recordBtn').style.display = 'block';
            document.getElementById('nextPromptBtn').style.display = 'none';
            
            updateProgress();
        }

        function showAdminLogin() {
            document.getElementById('surveyContainer').style.display = 'none';
            document.getElementById('adminLogin').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
        }

        function checkAdminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('loginError').style.display = 'none';
                loadAdminData();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('adminPassword').value = '';
            }
        }

        function logoutAdmin() {
            isAdminLoggedIn = false;
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminLogin').style.display = 'none';
            document.getElementById('surveyContainer').style.display = 'flex';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        function loadAdminData() {
            document.getElementById('totalFeedback').textContent = allFeedback.length;
            
            const sentimentScores = allFeedback.map(f => {
                if (f.sentiment === 'positive') return 1;
                if (f.sentiment === 'negative') return -1;
                return 0;
            });
            const avgSentiment = sentimentScores.length > 0 ? (sentimentScores.reduce((a, b) => a + b, 0) / sentimentScores.length).toFixed(1) : 0;
            document.getElementById('avgRating').textContent = avgSentiment;
            
            const wontonCounts = {};
            allFeedback.forEach(f => {
                wontonCounts[f.wonton] = (wontonCounts[f.wonton] || 0) + 1;
            });
            
            if (Object.keys(wontonCounts).length > 0) {
                const topWonton = Object.keys(wontonCounts).reduce((a, b) => wontonCounts[a] > wontonCounts[b] ? a : b);
                document.getElementById('topWonton').textContent = getWontonDisplayName(topWonton);
            }
            
            loadWontonChart();
            loadRecipeInsights();
            loadAudioRecordings();
        }

        function getWontonDisplayName(wontonKey) {
            const names = {
                'hangover-helper': 'Hangover Helper',
                'energy-boost': 'Energy Boost',
                'apres-adventure': 'Après-Adventure',
                'alpenglow-spicy': 'Alpenglow Spicy',
                'wind-down-sleepy': 'Wind-Down Sleepy'
            };
            return names[wontonKey] || wontonKey;
        }

        function loadWontonChart() {
            const wontonStats = {};
            allFeedback.forEach(f => {
                if (!wontonStats[f.wonton]) {
                    wontonStats[f.wonton] = { positive: 0, negative: 0, neutral: 0, total: 0 };
                }
                wontonStats[f.wonton][f.sentiment]++;
                wontonStats[f.wonton].total++;
            });
            
            let chartHTML = '';
            Object.entries(wontonStats).forEach(([wonton, stats]) => {
                const positivePercent = (stats.positive / stats.total * 100).toFixed(1);
                chartHTML += `
                    <div style="margin-bottom: 15px; padding: 15px; background: #f8f9ff; border-radius: 10px;">
                        <strong>${getWontonDisplayName(wonton)}</strong> (${stats.total} responses)
                        <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-top: 5px;">
                            <div style="background: #2ecc71; height: 20px; width: ${positivePercent}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                ${positivePercent}% positive
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('wontonChart').innerHTML = chartHTML || '<p>No data available yet.</p>';
        }

        function loadRecipeInsights() {
            const insights = {};
            
            allFeedback.forEach(f => {
                if (!insights[f.wonton]) {
                    insights[f.wonton] = {
                        name: getWontonDisplayName(f.wonton),
                        flavorIssues: [],
                        buyAgainCount: 0,
                        totalResponses: 0
                    };
                }
                
                const insight = insights[f.wonton];
                insight.totalResponses++;
                
                if (f.responses && f.responses.length > 0) {
                    f.responses.forEach(response => {
                        if (response.insights) {
                            if (response.insights.flavorFeedback) {
                                response.insights.flavorFeedback.forEach(feedback => {
                                    if (feedback.includes('negative:')) {
                                        insight.flavorIssues.push(feedback.replace('negative: ', ''));
                                    }
                                });
                            }
                            
                            if (response.insights.buyAgain) {
                                insight.buyAgainCount++;
                            }
                        }
                    });
                }
            });
            
            let insightsHTML = '';
            Object.values(insights).forEach(insight => {
                const buyAgainPercent = insight.totalResponses > 0 ? ((insight.buyAgainCount / insight.totalResponses) * 100).toFixed(1) : 0;
                
                insightsHTML += `
                    <div style="margin-bottom: 20px; padding: 20px; background: #f8f9ff; border-radius: 10px;">
                        <h4>${insight.name}</h4>
                        <p><strong>Would Buy Again:</strong> ${buyAgainPercent}%</p>
                        ${insight.flavorIssues.length > 0 ? `
                            <div style="margin: 10px 0;">
                                <strong style="color: #e74c3c;">Common Issues:</strong>
                                ${[...new Set(insight.flavorIssues)].join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            document.getElementById('recipeInsights').innerHTML = insightsHTML || '<p>No insights available yet.</p>';
        }

        function loadAudioRecordings() {
            const audioFeedback = allFeedback.filter(f => f.audioData || f.audioBlob);
            
            if (audioFeedback.length === 0) {
                document.getElementById('audioRecordings').innerHTML = '<p>No audio recordings yet.</p>';
                return;
            }
            
            let audioHTML = '';
            audioFeedback.forEach((feedback, index) => {
                const date = new Date(feedback.timestamp).toLocaleString();
                const textSummary = feedback.responses && feedback.responses[0] ? feedback.responses[0].response : 'No text summary provided';
                const sentiment = feedback.sentiment || 'unknown';
                
                audioHTML += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9ff; border-radius: 10px; border-left: 4px solid ${sentiment === 'positive' ? '#2ecc71' : sentiment === 'negative' ? '#e74c3c' : '#f39c12'};">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong>${feedback.customerName || 'Anonymous'}</strong> - ${getWontonDisplayName(feedback.wonton)}
                                <br><small style="color: #666;">${date}</small>
                            </div>
                            <span style="background: ${sentiment === 'positive' ? '#d4edda' : sentiment === 'negative' ? '#f8d7da' : '#fff3cd'}; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px;">
                                ${sentiment}
                            </span>
                        </div>
                        
                        ${feedback.audioData ? `
                            <audio controls style="width: 100%; margin: 10px 0;">
                                <source src="${feedback.audioData}" type="audio/wav">
                                Your browser does not support audio playback.
                            </audio>
                        ` : '<div style="color: #666; font-style: italic;">Audio data not available</div>'}
                        
                        <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 5px;">
                            <strong>Transcribed Text:</strong><br>
                            <em>"${textSummary}"</em>
                            ${feedback.responses && feedback.responses[0] && feedback.responses[0].transcriptionMethod ? 
                                `<br><small style="color: #666;">Method: ${feedback.responses[0].transcriptionMethod}</small>` : ''}
                        </div>
                        
                        ${feedback.effect ? `<div style="margin-top: 5px; color: #666;"><strong>Effects:</strong> ${feedback.effect}</div>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('audioRecordings').innerHTML = audioHTML;
        }

        function downloadHTML() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'yama-wonton-survey.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize
        updateProgress();
    </script>
</body>
</html>